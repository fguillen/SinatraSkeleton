From 0a48e9ac65293540b0d0adb3c5f45c4d8ca454af Mon Sep 17 00:00:00 2001
From: Fernando Guillen <fguillen.mail@gmail.com>
Date: Thu, 12 Dec 2013 16:41:48 +0100
Subject: [PATCH] Integrating Rollbar

---
 Gemfile                   |  1 +
 Gemfile.lock              |  4 ++++
 app/fake_publisher.rb     |  2 ++
 app/fake_publisher/app.rb | 19 +++++++++++++++++++
 lib/rollbar_extension.rb  | 13 +++++++++++++
 views/error.erb           | 10 ++++++++++
 6 files changed, 49 insertions(+)
 create mode 100644 lib/rollbar_extension.rb
 create mode 100644 views/error.erb

diff --git a/Gemfile b/Gemfile
index 2b1e7e8..1bad814 100644
--- a/Gemfile
+++ b/Gemfile
@@ -8,6 +8,7 @@ gem "rake"
 gem "mocha"
 gem "curb"
 gem "uuid"
+gem "rollbar"
 
 group :development do
   gem "rack-test"
diff --git a/Gemfile.lock b/Gemfile.lock
index 0e1530d..3beeece 100644
--- a/Gemfile.lock
+++ b/Gemfile.lock
@@ -26,6 +26,7 @@ GEM
     metaclass (0.0.1)
     mocha (0.14.0)
       metaclass (~> 0.0.1)
+    multi_json (1.8.2)
     net-scp (1.1.2)
       net-ssh (>= 2.6.5)
     net-ssh (2.7.0)
@@ -35,6 +36,8 @@ GEM
     rack-test (0.6.2)
       rack (>= 1.0)
     rake (10.1.0)
+    rollbar (0.12.1)
+      multi_json (~> 1.5)
     sinatra (1.4.4)
       rack (~> 1.4)
       rack-protection (~> 1.4)
@@ -67,6 +70,7 @@ DEPENDENCIES
   mocha
   rack-test
   rake
+  rollbar
   sinatra
   thin
   uuid
diff --git a/app/fake_publisher.rb b/app/fake_publisher.rb
index 21606c0..27e7a3d 100644
--- a/app/fake_publisher.rb
+++ b/app/fake_publisher.rb
@@ -1,7 +1,9 @@
+require "rollbar"
 require "sinatra/base"
 require "json"
 require "uuid"
 
+require_relative "../lib/rollbar_extension"
 require_relative "fake_publisher/utils"
 require_relative "fake_publisher/app"
 require_relative "fake_publisher/load_app_config"
diff --git a/app/fake_publisher/app.rb b/app/fake_publisher/app.rb
index 20b231b..bcc18a2 100644
--- a/app/fake_publisher/app.rb
+++ b/app/fake_publisher/app.rb
@@ -20,6 +20,25 @@ module FakePublisher
       $stderr.reopen(log_file)
     end
 
+    configure :staging, :production do
+      Rollbar.configure do |config|
+        config.access_token = "9fc125136c4746e4b9fbbc46393ad527"
+        config.environment = settings.environment
+        config.root = settings.root
+      end
+    end
+
+    error do
+      request_data = ::RequestDataExtractor.new.from_rack(env)
+      Rollbar.report_exception(env["sinatra.error"], request_data)
+      @error_data = JSON.pretty_generate(request_data)
+      erb :error
+    end
+
+    get "/exception" do
+      raise RuntimeError, "Test Exception"
+    end
+
     before "/" do
       session[:device_id] ||= UUID.new.generate
     end
diff --git a/lib/rollbar_extension.rb b/lib/rollbar_extension.rb
new file mode 100644
index 0000000..f033407
--- /dev/null
+++ b/lib/rollbar_extension.rb
@@ -0,0 +1,13 @@
+# Adapter around the default RequestDataExtractor
+class ::RequestDataExtractor
+  include Rollbar::RequestDataExtractor
+  def from_rack(env)
+    extract_request_data_from_rack(env).merge({
+      :route => env["PATH_INFO"]
+    })
+  end
+
+  def rollbar_request_params(env)
+    env['action_dispatch.request.parameters'] || {}
+  end
+end
\ No newline at end of file
diff --git a/views/error.erb b/views/error.erb
new file mode 100644
index 0000000..10ec14f
--- /dev/null
+++ b/views/error.erb
@@ -0,0 +1,10 @@
+<div class="jumbotron">
+  <h1>Oooops!</h1>
+  <p>You have found and error. Our programmers have been informed and they are already working on fixing it. Sorry for the inconveniences.</p>
+</div>
+
+<div style="display:none">
+  <pre>
+    <%= @error_data %>
+  </pre>
+</div>
\ No newline at end of file
-- 
1.8.3.4 (Apple Git-47)

